

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Interactive Queries &mdash; Apache Kafka 4.0.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../search.html"/>
    <link rel="top" title="Apache Kafka 4.0.0 documentation" href="../../../index.html"/>
        <link rel="up" title="Developer Guide for Kafka Streams" href="index.html"/>
        <link rel="next" title="Application Reset Tool" href="app-reset-tool.html"/>
        <link rel="prev" title="Data Types and Serialization" href="datatypes.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> Apache Kafka
          

          
          </a>

          
            
            
              <div class="version">
                4.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../uses.html">Use Cases</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Apache Kafka Documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../introduction.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api.html">Kafka APIs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../configuration.html">Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../design.html">Design</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../implementation.html">Implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ops.html">Operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../security.html">Security</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../connect.html">Kafka Connect</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Kafka Streams</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../quickstart.html">Run Kafka Streams Demo Application</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorial.html">Tutorial: Write a Kafka Streams Application</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core-concepts.html">Core Concepts</a></li>
<li class="toctree-l3"><a class="reference internal" href="../architecture.html">Architecture</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Developer Guide for Kafka Streams</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="config-streams.html">Configuring a Streams Application</a></li>
<li class="toctree-l4"><a class="reference internal" href="dsl-api.html">Streams DSL</a></li>
<li class="toctree-l4"><a class="reference internal" href="datatypes.html">Data Types and Serialization</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Interactive Queries</a></li>
<li class="toctree-l4"><a class="reference internal" href="app-reset-tool.html">Application Reset Tool</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../upgrade-guide.html">Upgrade Guide and API Changes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../index.html#why-you-ll-love-using-kafka-streams">Why you&#8217;ll love using Kafka Streams!</a></li>
<li class="toctree-l3"><a class="reference internal" href="../index.html#kafka-streams-use-cases">Kafka Streams use cases</a></li>
<li class="toctree-l3"><a class="reference internal" href="../index.html#hello-kafka-streams">Hello Kafka Streams</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Apache Kafka</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Apache Kafka Documentation</a> &raquo;</li>
        
          <li><a href="../index.html">Kafka Streams</a> &raquo;</li>
        
          <li><a href="index.html">Developer Guide for Kafka Streams</a> &raquo;</li>
        
      <li>Interactive Queries</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/documentation/streams/developer-guide/interactive-queries.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="interactive-queries">
<span id="streams-developer-guide-interactive-queries"></span><h1><a class="reference external" href="#interactive-queries">Interactive Queries</a><a class="headerlink" href="#interactive-queries" title="Permalink to this headline">¶</a></h1>
<p>Interactive queries allow you to leverage the state of your application
from outside your application. The Kafka Streams enables your
applications to be queryable.</p>
<div class="contents local topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#querying-local-state-stores-for-an-app-instance" id="id1">Querying local state stores for an app instance</a></li>
<li><a class="reference internal" href="#querying-local-key-value-stores" id="id2">Querying local key-value stores</a></li>
<li><a class="reference internal" href="#querying-local-window" id="id3">Querying local window</a></li>
<li><a class="reference internal" href="#querying-local-custom-state" id="id4">Querying local custom state</a></li>
<li><a class="reference internal" href="#querying-remote-state-stores-for-the-entire" id="id5">Querying remote state stores for the entire</a></li>
<li><a class="reference internal" href="#adding-an-rpc-layer-to-your" id="id6">Adding an RPC layer to your</a></li>
<li><a class="reference internal" href="#exposing-the-rpc-endpoints-of-your" id="id7">Exposing the RPC endpoints of your</a></li>
<li><a class="reference internal" href="#discovering-and-accessing-application-instances-and-their-local-state" id="id8">Discovering and accessing application instances and their local state</a></li>
</ul>
</div>
<p>The full state of your application is typically <a class="reference external" href="../architecture.html#streams-architecture-state">split across many
distributed instances of your
application</a>, and
across many state stores that are managed locally by these application
instances.</p>
<a class="reference internal image-reference" href="../../../_images/streams-interactive-queries-03.png"><img alt="../../../_images/streams-interactive-queries-03.png" class="align-center" src="../../../_images/streams-interactive-queries-03.png" style="width: 400px;" /></a>
<p>There are local and remote components to interactively querying the
state of your application.</p>
<dl class="docutils">
<dt>Local state</dt>
<dd>An application instance can query the locally managed portion of the
state and directly query its own local state stores. You can use the
corresponding local data in other parts of your application code, as
long as it doesn’t required calling the Kafka Streams API. Querying
state stores is always read-only to guarantee that the underlying
state stores will never be mutated out-of-band (e.g., you cannot add
new entries). State stores should only be mutated by the
corresponding processor topology and the input data it operates on.
For more information, see <a class="reference external" href="#streams-developer-guide-interactive-queries-local-stores">Querying local state stores for an app
instance</a>.</dd>
<dt>Remote state</dt>
<dd><p class="first">To query the full state of your application, you must connect the
various fragments of the state, including:</p>
<ul class="simple">
<li>query local state stores</li>
<li>discover all running instances of your application in the network
and their state stores</li>
<li>communicate with these instances over the network (e.g., an RPC
layer)</li>
</ul>
<p class="last">Connecting these fragments enables communication between instances
of the same app and communication from other applications for
interactive queries. For more information, see <a class="reference external" href="#streams-developer-guide-interactive-queries-discovery">Querying remote
state stores for the entire
app</a>.</p>
</dd>
</dl>
<p>Kafka Streams natively provides all of the required functionality for
interactively querying the state of your application, except if you want
to expose the full state of your application via interactive queries. To
allow application instances to communicate over the network, you must
add a Remote Procedure Call (RPC) layer to your application (e.g., REST
API).</p>
<p>This table shows the Kafka Streams native communication support for
various procedures.</p>
<table border="1" class="docutils">
<colgroup>
<col width="43%" />
<col width="26%" />
<col width="31%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Procedure</th>
<th class="head">Application
instance</th>
<th class="head">Entire application</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Query local state stores of
an app instance</td>
<td>Supported</td>
<td>Supported</td>
</tr>
<tr class="row-odd"><td>Make an app instance
discoverable to others</td>
<td>Supported</td>
<td>Supported</td>
</tr>
<tr class="row-even"><td>Discover all running app
instances and their state
stores</td>
<td>Supported</td>
<td>Supported</td>
</tr>
<tr class="row-odd"><td>Communicate with app
instances over the network
(RPC)</td>
<td>Supported</td>
<td>Not supported (you
must configure)</td>
</tr>
</tbody>
</table>
<div class="section" id="querying-local-state-stores-for-an-app-instance">
<h2><a class="reference external" href="#querying-local-state-stores-for-an-app-instance">Querying local state stores for an app instance</a><a class="headerlink" href="#querying-local-state-stores-for-an-app-instance" title="Permalink to this headline">¶</a></h2>
<p>A Kafka Streams application typically runs on multiple instances. The
state that is locally available on any given instance is only a subset
of the <a class="reference external" href="../architecture.html#streams-architecture-state">application’s entire
state</a>. Querying the
local stores on an instance will only return data locally available on
that particular instance.</p>
<p>The method <code class="docutils literal"><span class="pre">KafkaStreams#store(...)</span></code> finds an application instance’s
local state stores by name and type.</p>
<a class="reference internal image-reference" href="../../../_images/streams-interactive-queries-api-01.png"><img alt="../../../_images/streams-interactive-queries-api-01.png" class="align-center" src="../../../_images/streams-interactive-queries-api-01.png" style="width: 400px;" /></a>
<p>Every application instance can directly query any of its local state
stores.</p>
<p>The <em>name</em> of a state store is defined when you create the store. You
can create the store explicitly by using the Processor API or implicitly
by using stateful operations in the DSL.</p>
<p>The <em>type</em> of a state store is defined by <code class="docutils literal"><span class="pre">QueryableStoreType</span></code>. You
can access the built-in types via the class <code class="docutils literal"><span class="pre">QueryableStoreTypes</span></code>.
Kafka Streams currently has two built-in types:</p>
<ul class="simple">
<li>A key-value store <code class="docutils literal"><span class="pre">QueryableStoreTypes#keyValueStore()</span></code>, see
<a class="reference external" href="#streams-developer-guide-interactive-queries-local-key-value-stores">Querying local key-value
stores</a>.</li>
<li>A window store <code class="docutils literal"><span class="pre">QueryableStoreTypes#windowStore()</span></code>, see <a class="reference external" href="#streams-developer-guide-interactive-queries-local-window-stores">Querying
local window
stores</a>.</li>
</ul>
<p>You can also <a class="reference external" href="#streams-developer-guide-interactive-queries-custom-stores">implement your own
QueryableStoreType</a>
as described in section <a class="reference external" href="#streams-developer-guide-interactive-queries-custom-stores">Querying local custom state
stores</a>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Kafka Streams materializes one state store per stream partition. This
means your application will potentially manage many underlying state
stores. The API enables you to query all of the underlying stores
without having to know which partition the data is in.</p>
</div>
</div>
<div class="section" id="querying-local-key-value-stores">
<h2><a class="reference external" href="#querying-local-key-value-stores">Querying local key-value stores</a><a class="headerlink" href="#querying-local-key-value-stores" title="Permalink to this headline">¶</a></h2>
<p>To query a local key-value store, you must first create a topology with
a key-value store. This example creates a key-value store named
“CountsKeyValueStore”. This store will hold the latest count for any
word that is found on the topic “word-count-input”.</p>
<div class="code java highlight-default"><div class="highlight"><pre><span></span><span class="n">StreamsConfig</span> <span class="n">config</span> <span class="o">=</span> <span class="o">...</span><span class="p">;</span>
<span class="n">StreamsBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="o">...</span><span class="p">;</span>
<span class="n">KStream</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">textLines</span> <span class="o">=</span> <span class="o">...</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Define</span> <span class="n">the</span> <span class="n">processing</span> <span class="n">topology</span> <span class="p">(</span><span class="n">here</span><span class="p">:</span> <span class="n">WordCount</span><span class="p">)</span>
<span class="n">KGroupedStream</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">groupedByWord</span> <span class="o">=</span> <span class="n">textLines</span>
  <span class="o">.</span><span class="n">flatMapValues</span><span class="p">(</span><span class="n">value</span> <span class="o">-&gt;</span> <span class="n">Arrays</span><span class="o">.</span><span class="n">asList</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">toLowerCase</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">W+&quot;</span><span class="p">)))</span>
  <span class="o">.</span><span class="n">groupBy</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">word</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">word</span><span class="p">,</span> <span class="n">Serialized</span><span class="o">.</span><span class="k">with</span><span class="p">(</span><span class="n">stringSerde</span><span class="p">,</span> <span class="n">stringSerde</span><span class="p">));</span>

<span class="o">//</span> <span class="n">Create</span> <span class="n">a</span> <span class="n">key</span><span class="o">-</span><span class="n">value</span> <span class="n">store</span> <span class="n">named</span> <span class="s2">&quot;CountsKeyValueStore&quot;</span> <span class="k">for</span> <span class="n">the</span> <span class="nb">all</span><span class="o">-</span><span class="n">time</span> <span class="n">word</span> <span class="n">counts</span>
<span class="n">groupedByWord</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">Materialized</span><span class="o">.&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">KeyValueStore</span><span class="o">&lt;</span><span class="n">Bytes</span><span class="p">,</span> <span class="n">byte</span><span class="p">[]</span><span class="o">&gt;</span><span class="k">as</span><span class="p">(</span><span class="s2">&quot;CountsKeyValueStore&quot;</span><span class="p">));</span>

<span class="o">//</span> <span class="n">Start</span> <span class="n">an</span> <span class="n">instance</span> <span class="n">of</span> <span class="n">the</span> <span class="n">topology</span>
<span class="n">KafkaStreams</span> <span class="n">streams</span> <span class="o">=</span> <span class="n">new</span> <span class="n">KafkaStreams</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span> <span class="n">config</span><span class="p">);</span>
<span class="n">streams</span><span class="o">.</span><span class="n">start</span><span class="p">();</span>
</pre></div>
</div>
<p>After the application has started, you can get access to
“CountsKeyValueStore” and then query it via the
<a class="reference external" href="https://github.com/apache/kafka/blob/1.0/streams/src/main/java/org/apache/kafka/streams/state/ReadOnlyKeyValueStore.java">ReadOnlyKeyValueStore</a>
API:</p>
<div class="code java highlight-default"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Get</span> <span class="n">the</span> <span class="n">key</span><span class="o">-</span><span class="n">value</span> <span class="n">store</span> <span class="n">CountsKeyValueStore</span>
<span class="n">ReadOnlyKeyValueStore</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="n">keyValueStore</span> <span class="o">=</span>
    <span class="n">streams</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="s2">&quot;CountsKeyValueStore&quot;</span><span class="p">,</span> <span class="n">QueryableStoreTypes</span><span class="o">.</span><span class="n">keyValueStore</span><span class="p">());</span>

<span class="o">//</span> <span class="n">Get</span> <span class="n">value</span> <span class="n">by</span> <span class="n">key</span>
<span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&quot;count for hello:&quot;</span> <span class="o">+</span> <span class="n">keyValueStore</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">));</span>

<span class="o">//</span> <span class="n">Get</span> <span class="n">the</span> <span class="n">values</span> <span class="k">for</span> <span class="n">a</span> <span class="nb">range</span> <span class="n">of</span> <span class="n">keys</span> <span class="n">available</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">application</span> <span class="n">instance</span>
<span class="n">KeyValueIterator</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="nb">range</span> <span class="o">=</span> <span class="n">keyValueStore</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="s2">&quot;streams&quot;</span><span class="p">);</span>
<span class="k">while</span> <span class="p">(</span><span class="nb">range</span><span class="o">.</span><span class="n">hasNext</span><span class="p">())</span> <span class="p">{</span>
  <span class="n">KeyValue</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="nb">next</span> <span class="o">=</span> <span class="nb">range</span><span class="o">.</span><span class="n">next</span><span class="p">();</span>
  <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&quot;count for &quot;</span> <span class="o">+</span> <span class="nb">next</span><span class="o">.</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="o">//</span> <span class="n">Get</span> <span class="n">the</span> <span class="n">values</span> <span class="k">for</span> <span class="nb">all</span> <span class="n">of</span> <span class="n">the</span> <span class="n">keys</span> <span class="n">available</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">application</span> <span class="n">instance</span>
<span class="n">KeyValueIterator</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="nb">range</span> <span class="o">=</span> <span class="n">keyValueStore</span><span class="o">.</span><span class="n">all</span><span class="p">();</span>
<span class="k">while</span> <span class="p">(</span><span class="nb">range</span><span class="o">.</span><span class="n">hasNext</span><span class="p">())</span> <span class="p">{</span>
  <span class="n">KeyValue</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="nb">next</span> <span class="o">=</span> <span class="nb">range</span><span class="o">.</span><span class="n">next</span><span class="p">();</span>
  <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&quot;count for &quot;</span> <span class="o">+</span> <span class="nb">next</span><span class="o">.</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You can also materialize the results of stateless operators by using the
overloaded methods that take a <code class="docutils literal"><span class="pre">queryableStoreName</span></code> as shown in the
example below:</p>
<div class="code java highlight-default"><div class="highlight"><pre><span></span><span class="n">StreamsConfig</span> <span class="n">config</span> <span class="o">=</span> <span class="o">...</span><span class="p">;</span>
<span class="n">StreamsBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="o">...</span><span class="p">;</span>
<span class="n">KTable</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">regionCounts</span> <span class="o">=</span> <span class="o">...</span><span class="p">;</span>

<span class="o">//</span> <span class="n">materialize</span> <span class="n">the</span> <span class="n">result</span> <span class="n">of</span> <span class="n">filtering</span> <span class="n">corresponding</span> <span class="n">to</span> <span class="n">odd</span> <span class="n">numbers</span>
<span class="o">//</span> <span class="n">the</span> <span class="s2">&quot;queryableStoreName&quot;</span> <span class="n">can</span> <span class="n">be</span> <span class="n">subsequently</span> <span class="n">queried</span><span class="o">.</span>
<span class="n">KTable</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">oddCounts</span> <span class="o">=</span> <span class="n">numberLines</span><span class="o">.</span><span class="n">filter</span><span class="p">((</span><span class="n">region</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">count</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">),</span>
  <span class="n">Materialized</span><span class="o">.&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">KeyValueStore</span><span class="o">&lt;</span><span class="n">Bytes</span><span class="p">,</span> <span class="n">byte</span><span class="p">[]</span><span class="o">&gt;</span><span class="k">as</span><span class="p">(</span><span class="s2">&quot;queryableStoreName&quot;</span><span class="p">));</span>

<span class="o">//</span> <span class="n">do</span> <span class="ow">not</span> <span class="n">materialize</span> <span class="n">the</span> <span class="n">result</span> <span class="n">of</span> <span class="n">filtering</span> <span class="n">corresponding</span> <span class="n">to</span> <span class="n">even</span> <span class="n">numbers</span>
<span class="o">//</span> <span class="n">this</span> <span class="n">means</span> <span class="n">that</span> <span class="n">these</span> <span class="n">results</span> <span class="n">will</span> <span class="ow">not</span> <span class="n">be</span> <span class="n">materialized</span> <span class="ow">and</span> <span class="n">cannot</span> <span class="n">be</span> <span class="n">queried</span><span class="o">.</span>
<span class="n">KTable</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">oddCounts</span> <span class="o">=</span> <span class="n">numberLines</span><span class="o">.</span><span class="n">filter</span><span class="p">((</span><span class="n">region</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">count</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">));</span>
</pre></div>
</div>
</div>
<div class="section" id="querying-local-window">
<h2><a class="reference external" href="#querying-local-window-stores">Querying local window</a><a class="headerlink" href="#querying-local-window" title="Permalink to this headline">¶</a></h2>
<p>A window store will potentially have many results for any given key
because the key can be present in multiple windows. However, there is
only one result per window for a given key.</p>
<p>To query a local window store, you must first create a topology with a
window store. This example creates a window store named
“CountsWindowStore” that contains the counts for words in 1-minute
windows.</p>
<div class="code java highlight-default"><div class="highlight"><pre><span></span><span class="n">StreamsConfig</span> <span class="n">config</span> <span class="o">=</span> <span class="o">...</span><span class="p">;</span>
<span class="n">StreamsBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="o">...</span><span class="p">;</span>
<span class="n">KStream</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">textLines</span> <span class="o">=</span> <span class="o">...</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Define</span> <span class="n">the</span> <span class="n">processing</span> <span class="n">topology</span> <span class="p">(</span><span class="n">here</span><span class="p">:</span> <span class="n">WordCount</span><span class="p">)</span>
<span class="n">KGroupedStream</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">groupedByWord</span> <span class="o">=</span> <span class="n">textLines</span>
  <span class="o">.</span><span class="n">flatMapValues</span><span class="p">(</span><span class="n">value</span> <span class="o">-&gt;</span> <span class="n">Arrays</span><span class="o">.</span><span class="n">asList</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">toLowerCase</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">W+&quot;</span><span class="p">)))</span>
  <span class="o">.</span><span class="n">groupBy</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">word</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">word</span><span class="p">,</span> <span class="n">Serialized</span><span class="o">.</span><span class="k">with</span><span class="p">(</span><span class="n">stringSerde</span><span class="p">,</span> <span class="n">stringSerde</span><span class="p">));</span>

<span class="o">//</span> <span class="n">Create</span> <span class="n">a</span> <span class="n">window</span> <span class="n">state</span> <span class="n">store</span> <span class="n">named</span> <span class="s2">&quot;CountsWindowStore&quot;</span> <span class="n">that</span> <span class="n">contains</span> <span class="n">the</span> <span class="n">word</span> <span class="n">counts</span> <span class="k">for</span> <span class="n">every</span> <span class="n">minute</span>
<span class="n">groupedByWord</span><span class="o">.</span><span class="n">windowedBy</span><span class="p">(</span><span class="n">TimeWindows</span><span class="o">.</span><span class="n">of</span><span class="p">(</span><span class="mi">60000</span><span class="p">))</span>
  <span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">Materialized</span><span class="o">.&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Long</span><span class="p">,</span> <span class="n">WindowStore</span><span class="o">&lt;</span><span class="n">Bytes</span><span class="p">,</span> <span class="n">byte</span><span class="p">[]</span><span class="o">&gt;</span><span class="k">as</span><span class="p">(</span><span class="s2">&quot;CountsWindowStore&quot;</span><span class="p">));</span>
</pre></div>
</div>
<p>After the application has started, you can get access to
“CountsWindowStore” and then query it via the
<a class="reference external" href="https://github.com/apache/kafka/blob/1.0/streams/src/main/java/org/apache/kafka/streams/state/ReadOnlyWindowStore.java">ReadOnlyWindowStore</a>
API:</p>
<div class="code java highlight-default"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Get</span> <span class="n">the</span> <span class="n">window</span> <span class="n">store</span> <span class="n">named</span> <span class="s2">&quot;CountsWindowStore&quot;</span>
<span class="n">ReadOnlyWindowStore</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="n">windowStore</span> <span class="o">=</span>
    <span class="n">streams</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="s2">&quot;CountsWindowStore&quot;</span><span class="p">,</span> <span class="n">QueryableStoreTypes</span><span class="o">.</span><span class="n">windowStore</span><span class="p">());</span>

<span class="o">//</span> <span class="n">Fetch</span> <span class="n">values</span> <span class="k">for</span> <span class="n">the</span> <span class="n">key</span> <span class="s2">&quot;world&quot;</span> <span class="k">for</span> <span class="nb">all</span> <span class="n">of</span> <span class="n">the</span> <span class="n">windows</span> <span class="n">available</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">application</span> <span class="n">instance</span><span class="o">.</span>
<span class="o">//</span> <span class="n">To</span> <span class="n">get</span> <span class="o">*</span><span class="nb">all</span><span class="o">*</span> <span class="n">available</span> <span class="n">windows</span> <span class="n">we</span> <span class="n">fetch</span> <span class="n">windows</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">beginning</span> <span class="n">of</span> <span class="n">time</span> <span class="n">until</span> <span class="n">now</span><span class="o">.</span>
<span class="n">long</span> <span class="n">timeFrom</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">//</span> <span class="n">beginning</span> <span class="n">of</span> <span class="n">time</span> <span class="o">=</span> <span class="n">oldest</span> <span class="n">available</span>
<span class="n">long</span> <span class="n">timeTo</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">currentTimeMillis</span><span class="p">();</span> <span class="o">//</span> <span class="n">now</span> <span class="p">(</span><span class="ow">in</span> <span class="n">processing</span><span class="o">-</span><span class="n">time</span><span class="p">)</span>
<span class="n">WindowStoreIterator</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">iterator</span> <span class="o">=</span> <span class="n">windowStore</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;world&quot;</span><span class="p">,</span> <span class="n">timeFrom</span><span class="p">,</span> <span class="n">timeTo</span><span class="p">);</span>
<span class="k">while</span> <span class="p">(</span><span class="n">iterator</span><span class="o">.</span><span class="n">hasNext</span><span class="p">())</span> <span class="p">{</span>
  <span class="n">KeyValue</span><span class="o">&lt;</span><span class="n">Long</span><span class="p">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="nb">next</span> <span class="o">=</span> <span class="n">iterator</span><span class="o">.</span><span class="n">next</span><span class="p">();</span>
  <span class="n">long</span> <span class="n">windowTimestamp</span> <span class="o">=</span> <span class="nb">next</span><span class="o">.</span><span class="n">key</span><span class="p">;</span>
  <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&quot;Count of &#39;world&#39; @ time &quot;</span> <span class="o">+</span> <span class="n">windowTimestamp</span> <span class="o">+</span> <span class="s2">&quot; is &quot;</span> <span class="o">+</span> <span class="nb">next</span><span class="o">.</span><span class="n">value</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="querying-local-custom-state">
<h2><a class="reference external" href="#querying-local-custom-state-stores">Querying local custom state</a><a class="headerlink" href="#querying-local-custom-state" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Only the <a class="reference external" href="processor-api.html#streams-developer-guide-processor-api">Processor
API</a>
supports custom state stores.</p>
</div>
<p>Before querying the custom state stores you must implement these
interfaces:</p>
<ul class="simple">
<li>Your custom state store must implement <code class="docutils literal"><span class="pre">StateStore</span></code>.</li>
<li>You must have an interface to represent the operations available on
the store.</li>
<li>You must provide an implementation of <code class="docutils literal"><span class="pre">StoreBuilder</span></code> for creating
instances of your store.</li>
<li>It is recommended that you provide an interface that restricts access
to read-only operations. This prevents users of this API from
mutating the state of your running Kafka Streams application
out-of-band.</li>
</ul>
<p>The class/interface hierarchy for your custom store might look something
like:</p>
<div class="code java highlight-default"><div class="highlight"><pre><span></span><span class="n">public</span> <span class="k">class</span> <span class="nc">MyCustomStore</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">implements</span> <span class="n">StateStore</span><span class="p">,</span> <span class="n">MyWriteableCustomStore</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="o">//</span> <span class="n">implementation</span> <span class="n">of</span> <span class="n">the</span> <span class="n">actual</span> <span class="n">store</span>
<span class="p">}</span>

<span class="o">//</span> <span class="n">Read</span><span class="o">-</span><span class="n">write</span> <span class="n">interface</span> <span class="k">for</span> <span class="n">MyCustomStore</span>
<span class="n">public</span> <span class="n">interface</span> <span class="n">MyWriteableCustomStore</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">extends</span> <span class="n">MyReadableCustomStore</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="n">void</span> <span class="n">write</span><span class="p">(</span><span class="n">K</span> <span class="n">Key</span><span class="p">,</span> <span class="n">V</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="o">//</span> <span class="n">Read</span><span class="o">-</span><span class="n">only</span> <span class="n">interface</span> <span class="k">for</span> <span class="n">MyCustomStore</span>
<span class="n">public</span> <span class="n">interface</span> <span class="n">MyReadableCustomStore</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="n">V</span> <span class="n">read</span><span class="p">(</span><span class="n">K</span> <span class="n">key</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">public</span> <span class="k">class</span> <span class="nc">MyCustomStoreBuilder</span> <span class="n">implements</span> <span class="n">StoreBuilder</span> <span class="p">{</span>
  <span class="o">//</span> <span class="n">implementation</span> <span class="n">of</span> <span class="n">the</span> <span class="n">supplier</span> <span class="k">for</span> <span class="n">MyCustomStore</span>
<span class="p">}</span>
</pre></div>
</div>
<p>To make this store queryable you must:</p>
<ul class="simple">
<li>Provide an implementation of
<a class="reference external" href="https://github.com/apache/kafka/blob/1.0/streams/src/main/java/org/apache/kafka/streams/state/QueryableStoreType.java">QueryableStoreType</a>.</li>
<li>Provide a wrapper class that has access to all of the underlying
instances of the store and is used for querying.</li>
</ul>
<p>Here is how to implement <code class="docutils literal"><span class="pre">QueryableStoreType</span></code>:</p>
<div class="code java highlight-default"><div class="highlight"><pre><span></span><span class="n">public</span> <span class="k">class</span> <span class="nc">MyCustomStoreType</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">implements</span> <span class="n">QueryableStoreType</span><span class="o">&lt;</span><span class="n">MyReadableCustomStore</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span><span class="n">V</span><span class="o">&gt;&gt;</span> <span class="p">{</span>

  <span class="o">//</span> <span class="n">Only</span> <span class="n">accept</span> <span class="n">StateStores</span> <span class="n">that</span> <span class="n">are</span> <span class="n">of</span> <span class="nb">type</span> <span class="n">MyCustomStore</span>
  <span class="n">public</span> <span class="n">boolean</span> <span class="n">accepts</span><span class="p">(</span><span class="n">final</span> <span class="n">StateStore</span> <span class="n">stateStore</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">stateStore</span> <span class="n">instanceOf</span> <span class="n">MyCustomStore</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">public</span> <span class="n">MyReadableCustomStore</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">create</span><span class="p">(</span><span class="n">final</span> <span class="n">StateStoreProvider</span> <span class="n">storeProvider</span><span class="p">,</span> <span class="n">final</span> <span class="n">String</span> <span class="n">storeName</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">new</span> <span class="n">MyCustomStoreTypeWrapper</span><span class="p">(</span><span class="n">storeProvider</span><span class="p">,</span> <span class="n">storeName</span><span class="p">,</span> <span class="n">this</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<p>A wrapper class is required because each instance of a Kafka Streams
application may run multiple stream tasks and manage multiple local
instances of a particular state store. The wrapper class hides this
complexity and lets you query a “logical” state store by name without
having to know about all of the underlying local instances of that state
store.</p>
<p>When implementing your wrapper class you must use the
<a class="reference external" href="https://github.com/apache/kafka/blob/1.0/streams/src/main/java/org/apache/kafka/streams/state/internals/StateStoreProvider.java">StateStoreProvider</a>
interface to get access to the underlying instances of your store.
<code class="docutils literal"><span class="pre">StateStoreProvider#stores(String</span> <span class="pre">storeName,</span> <span class="pre">QueryableStoreType&lt;T&gt;</span> <span class="pre">queryableStoreType)</span></code>
returns a <code class="docutils literal"><span class="pre">List</span></code> of state stores with the given storeName and of the
type as defined by <code class="docutils literal"><span class="pre">queryableStoreType</span></code>.</p>
<p>Here is an example implementation of the wrapper follows (Java 8+):</p>
<div class="code java highlight-default"><div class="highlight"><pre><span></span>// We strongly recommended implementing a read-only interface
// to restrict usage of the store to safe read operations!
public class MyCustomStoreTypeWrapper&lt;K,V&gt; implements MyReadableCustomStore&lt;K,V&gt; {

  private final QueryableStoreType&lt;MyReadableCustomStore&lt;K, V&gt;&gt; customStoreType;
  private final String storeName;
  private final StateStoreProvider provider;

  public CustomStoreTypeWrapper(final StateStoreProvider provider,
                                final String storeName,
                                final QueryableStoreType&lt;MyReadableCustomStore&lt;K, V&gt;&gt; customStoreType) {

    // ... assign fields ...
  }

  // Implement a safe read method
  @Override
  public V read(final K key) {
    // Get all the stores with storeName and of customStoreType
    final List&lt;MyReadableCustomStore&lt;K, V&gt;&gt; stores = provider.getStores(storeName, customStoreType);
    // Try and find the value for the given key
    final Optional&lt;V&gt; value = stores.stream().filter(store -&gt; store.read(key) != null).findFirst();
    // Return the value if it exists
    return value.orElse(null);
  }

}
</pre></div>
</div>
<p>You can now find and query your custom store:</p>
<div class="code java highlight-default"><div class="highlight"><pre><span></span><span class="n">StreamsConfig</span> <span class="n">config</span> <span class="o">=</span> <span class="o">...</span><span class="p">;</span>
<span class="n">Topology</span> <span class="n">topology</span> <span class="o">=</span> <span class="o">...</span><span class="p">;</span>
<span class="n">ProcessorSupplier</span> <span class="n">processorSuppler</span> <span class="o">=</span> <span class="o">...</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Create</span> <span class="n">CustomStoreSupplier</span> <span class="k">for</span> <span class="n">store</span> <span class="n">name</span> <span class="n">the</span><span class="o">-</span><span class="n">custom</span><span class="o">-</span><span class="n">store</span>
<span class="n">MyCustomStoreBuilder</span> <span class="n">customStoreBuilder</span> <span class="o">=</span> <span class="n">new</span> <span class="n">MyCustomStoreBuilder</span><span class="p">(</span><span class="s2">&quot;the-custom-store&quot;</span><span class="p">)</span> <span class="o">//...</span><span class="p">;</span>
<span class="o">//</span> <span class="n">Add</span> <span class="n">the</span> <span class="n">source</span> <span class="n">topic</span>
<span class="n">topology</span><span class="o">.</span><span class="n">addSource</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="s2">&quot;inputTopic&quot;</span><span class="p">);</span>
<span class="o">//</span> <span class="n">Add</span> <span class="n">a</span> <span class="n">custom</span> <span class="n">processor</span> <span class="n">that</span> <span class="n">reads</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">source</span> <span class="n">topic</span>
<span class="n">topology</span><span class="o">.</span><span class="n">addProcessor</span><span class="p">(</span><span class="s2">&quot;the-processor&quot;</span><span class="p">,</span> <span class="n">processorSupplier</span><span class="p">,</span> <span class="s2">&quot;input&quot;</span><span class="p">);</span>
<span class="o">//</span> <span class="n">Connect</span> <span class="n">your</span> <span class="n">custom</span> <span class="n">state</span> <span class="n">store</span> <span class="n">to</span> <span class="n">the</span> <span class="n">custom</span> <span class="n">processor</span> <span class="n">above</span>
<span class="n">topology</span><span class="o">.</span><span class="n">addStateStore</span><span class="p">(</span><span class="n">customStoreBuilder</span><span class="p">,</span> <span class="s2">&quot;the-processor&quot;</span><span class="p">);</span>

<span class="n">KafkaStreams</span> <span class="n">streams</span> <span class="o">=</span> <span class="n">new</span> <span class="n">KafkaStreams</span><span class="p">(</span><span class="n">topology</span><span class="p">,</span> <span class="n">config</span><span class="p">);</span>
<span class="n">streams</span><span class="o">.</span><span class="n">start</span><span class="p">();</span>

<span class="o">//</span> <span class="n">Get</span> <span class="n">access</span> <span class="n">to</span> <span class="n">the</span> <span class="n">custom</span> <span class="n">store</span>
<span class="n">MyReadableCustomStore</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">store</span> <span class="o">=</span> <span class="n">streams</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="s2">&quot;the-custom-store&quot;</span><span class="p">,</span> <span class="n">new</span> <span class="n">MyCustomStoreType</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">String</span><span class="o">&gt;</span><span class="p">());</span>
<span class="o">//</span> <span class="n">Query</span> <span class="n">the</span> <span class="n">store</span>
<span class="n">String</span> <span class="n">value</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="querying-remote-state-stores-for-the-entire">
<h2><a class="reference external" href="#querying-remote-state-stores-for-the-entire-app">Querying remote state stores for the entire</a><a class="headerlink" href="#querying-remote-state-stores-for-the-entire" title="Permalink to this headline">¶</a></h2>
<p>To query remote states for the entire app, you must expose the
application’s full state to other applications, including applications
that are running on different machines.</p>
<p>For example, you have a Kafka Streams application that processes user
events in a multi-player video game, and you want to retrieve the latest
status of each user directly and display it in a mobile app. Here are
the required steps to make the full state of your application queryable:</p>
<ol class="arabic simple">
<li><a class="reference external" href="#streams-developer-guide-interactive-queries-rpc-layer">Add an RPC layer to your
application</a>
so that the instances of your application can be interacted with via
the network (e.g., a REST API, Thrift, a custom protocol, and so on).
The instances must respond to interactive queries. You can follow the
reference examples provided to get started.</li>
<li><a class="reference external" href="#streams-developer-guide-interactive-queries-expose-rpc">Expose the RPC
endpoints</a>
of your application’s instances via the <code class="docutils literal"><span class="pre">application.server</span></code>
configuration setting of Kafka Streams. Because RPC endpoints must be
unique within a network, each instance has its own value for this
configuration setting. This makes an application instance
discoverable by other instances.</li>
<li>In the RPC layer, <a class="reference external" href="#streams-developer-guide-interactive-queries-discover-app-instances-and-stores">discover remote application
instances</a>
and their state stores and <a class="reference external" href="#streams-developer-guide-interactive-queries-local-stores">query locally available state
stores</a>
to make the full state of your application queryable. The remote
application instances can forward queries to other app instances if a
particular instance lacks the local data to respond to a query. The
locally available state stores can directly respond to queries.</li>
</ol>
<a class="reference internal image-reference" href="../../../_images/streams-interactive-queries-api-02.png"><img alt="../../../_images/streams-interactive-queries-api-02.png" class="align-center" src="../../../_images/streams-interactive-queries-api-02.png" style="width: 400px;" /></a>
<p>Discover any running instances of the same application as well as the
respective RPC endpoints they expose for interactive queries</p>
</div>
<div class="section" id="adding-an-rpc-layer-to-your">
<h2><a class="reference external" href="#adding-an-rpc-layer-to-your-application">Adding an RPC layer to your</a><a class="headerlink" href="#adding-an-rpc-layer-to-your" title="Permalink to this headline">¶</a></h2>
<p>There are many ways to add an RPC layer. The only requirements are that
the RPC layer is embedded within the Kafka Streams application and that
it exposes an endpoint that other application instances and applications
can connect to.</p>
</div>
<div class="section" id="exposing-the-rpc-endpoints-of-your">
<h2><a class="reference external" href="#exposing-the-rpc-endpoints-of-your-application">Exposing the RPC endpoints of your</a><a class="headerlink" href="#exposing-the-rpc-endpoints-of-your" title="Permalink to this headline">¶</a></h2>
<p>To enable remote state store discovery in a distributed Kafka Streams
application, you must set the <a class="reference external" href="config-streams.html#streams-developer-guide-required-configs">configuration
property</a>
in <code class="docutils literal"><span class="pre">StreamsConfig</span></code>. The <code class="docutils literal"><span class="pre">application.server</span></code> property defines a
unique <code class="docutils literal"><span class="pre">host:port</span></code> pair that points to the RPC endpoint of the
respective instance of a Kafka Streams application. The value of this
configuration property will vary across the instances of your
application. When this property is set, Kafka Streams will keep track of
the RPC endpoint information for every instance of an application, its
state stores, and assigned stream partitions through instances of
<a class="reference external" href="../javadocs/org/apache/kafka/streams/state/StreamsMetadata.html">StreamsMetadata</a>.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">Consider leveraging the exposed RPC endpoints of your application for
further functionality, such as piggybacking additional inter-application
communication that goes beyond interactive queries.</p>
</div>
<p>This example shows how to configure and run a Kafka Streams application
that supports the discovery of its state stores.</p>
<div class="code java highlight-default"><div class="highlight"><pre><span></span>Properties props = new Properties();
// Set the unique RPC endpoint of this application instance through which it
// can be interactively queried.  In a real application, the value would most
// probably not be hardcoded but derived dynamically.
String rpcEndpoint = &quot;host1:4460&quot;;
props.put(StreamsConfig.APPLICATION_SERVER_CONFIG, rpcEndpoint);
// ... further settings may follow here ...

StreamsConfig config = new StreamsConfig(props);
StreamsBuilder builder = new StreamsBuilder();

KStream&lt;String, String&gt; textLines = builder.stream(stringSerde, stringSerde, &quot;word-count-input&quot;);

final KGroupedStream&lt;String, String&gt; groupedByWord = textLines
    .flatMapValues(value -&gt; Arrays.asList(value.toLowerCase().split(&quot;\\W+&quot;)))
    .groupBy((key, word) -&gt; word, Serialized.with(stringSerde, stringSerde));

// This call to `count()` creates a state store named &quot;word-count&quot;.
// The state store is discoverable and can be queried interactively.
groupedByWord.count(Materialized.&lt;String, Long, KeyValueStore&lt;Bytes, byte[]&gt;as(&quot;word-count&quot;));

// Start an instance of the topology
KafkaStreams streams = new KafkaStreams(builder, streamsConfiguration);
streams.start();

// Then, create and start the actual RPC service for remote access to this
// application instance&#39;s local state stores.
//
// This service should be started on the same host and port as defined above by
// the property `StreamsConfig.APPLICATION_SERVER_CONFIG`.  The example below is
// fictitious, but we provide end-to-end demo applications (such as KafkaMusicExample)
// that showcase how to implement such a service to get you started.
MyRPCService rpcService = ...;
rpcService.listenAt(rpcEndpoint);
</pre></div>
</div>
</div>
<div class="section" id="discovering-and-accessing-application-instances-and-their-local-state">
<h2><a class="reference external" href="#discovering-and-accessing-application-instances-and-their-local-state-stores">Discovering and accessing application instances and their local state</a><a class="headerlink" href="#discovering-and-accessing-application-instances-and-their-local-state" title="Permalink to this headline">¶</a></h2>
<p>The following methods return
<a class="reference external" href="../javadocs/org/apache/kafka/streams/state/StreamsMetadata.html">StreamsMetadata</a>
objects, which provide meta-information about application instances such
as their RPC endpoint and locally available state stores.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">KafkaStreams#allMetadata()</span></code>: find all instances of this
application</li>
<li><code class="docutils literal"><span class="pre">KafkaStreams#allMetadataForStore(String</span> <span class="pre">storeName)</span></code>: find those
applications instances that manage local instances of the state store
“storeName”</li>
<li><code class="docutils literal"><span class="pre">KafkaStreams#metadataForKey(String</span> <span class="pre">storeName,</span> <span class="pre">K</span> <span class="pre">key,</span> <span class="pre">Serializer&lt;K&gt;</span> <span class="pre">keySerializer)</span></code>:
using the default stream partitioning strategy, find the one
application instance that holds the data for the given key in the
given state store</li>
<li><code class="docutils literal"><span class="pre">KafkaStreams#metadataForKey(String</span> <span class="pre">storeName,</span> <span class="pre">K</span> <span class="pre">key,</span> <span class="pre">StreamPartitioner&lt;K,</span> <span class="pre">?&gt;</span> <span class="pre">partitioner)</span></code>:
using <code class="docutils literal"><span class="pre">partitioner</span></code>, find the one application instance that holds
the data for the given key in the given state store</li>
</ul>
<div class="admonition attention">
<p class="first admonition-title">Attention</p>
<p class="last">If <code class="docutils literal"><span class="pre">application.server</span></code> is not configured for an application instance,
then the above methods will not find any
<a class="reference external" href="../javadocs/org/apache/kafka/streams/state/StreamsMetadata.html">StreamsMetadata</a>
for it.</p>
</div>
<p>For example, we can now find the <code class="docutils literal"><span class="pre">StreamsMetadata</span></code> for the state store
named “word-count” that we defined in the code example shown in the
previous section:</p>
<div class="code java highlight-default"><div class="highlight"><pre><span></span><span class="n">KafkaStreams</span> <span class="n">streams</span> <span class="o">=</span> <span class="o">...</span><span class="p">;</span>
<span class="o">//</span> <span class="n">Find</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">locations</span> <span class="n">of</span> <span class="n">local</span> <span class="n">instances</span> <span class="n">of</span> <span class="n">the</span> <span class="n">state</span> <span class="n">store</span> <span class="n">named</span> <span class="s2">&quot;word-count&quot;</span>
<span class="n">Collection</span><span class="o">&lt;</span><span class="n">StreamsMetadata</span><span class="o">&gt;</span> <span class="n">wordCountHosts</span> <span class="o">=</span> <span class="n">streams</span><span class="o">.</span><span class="n">allMetadataForStore</span><span class="p">(</span><span class="s2">&quot;word-count&quot;</span><span class="p">);</span>

<span class="o">//</span> <span class="n">For</span> <span class="n">illustrative</span> <span class="n">purposes</span><span class="p">,</span> <span class="n">we</span> <span class="n">assume</span> <span class="n">using</span> <span class="n">an</span> <span class="n">HTTP</span> <span class="n">client</span> <span class="n">to</span> <span class="n">talk</span> <span class="n">to</span> <span class="n">remote</span> <span class="n">app</span> <span class="n">instances</span><span class="o">.</span>
<span class="n">HttpClient</span> <span class="n">http</span> <span class="o">=</span> <span class="o">...</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Get</span> <span class="n">the</span> <span class="n">word</span> <span class="n">count</span> <span class="k">for</span> <span class="n">word</span> <span class="p">(</span><span class="n">aka</span> <span class="n">key</span><span class="p">)</span> <span class="s1">&#39;alice&#39;</span><span class="p">:</span> <span class="n">Approach</span> <span class="mi">1</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">We</span> <span class="n">first</span> <span class="n">find</span> <span class="n">the</span> <span class="n">one</span> <span class="n">app</span> <span class="n">instance</span> <span class="n">that</span> <span class="n">manages</span> <span class="n">the</span> <span class="n">count</span> <span class="k">for</span> <span class="s1">&#39;alice&#39;</span> <span class="ow">in</span> <span class="n">its</span> <span class="n">local</span> <span class="n">state</span> <span class="n">stores</span><span class="o">.</span>
<span class="n">StreamsMetadata</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">streams</span><span class="o">.</span><span class="n">metadataForKey</span><span class="p">(</span><span class="s2">&quot;word-count&quot;</span><span class="p">,</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="n">Serdes</span><span class="o">.</span><span class="n">String</span><span class="p">()</span><span class="o">.</span><span class="n">serializer</span><span class="p">());</span>
<span class="o">//</span> <span class="n">Then</span><span class="p">,</span> <span class="n">we</span> <span class="n">query</span> <span class="n">only</span> <span class="n">that</span> <span class="n">single</span> <span class="n">app</span> <span class="n">instance</span> <span class="k">for</span> <span class="n">the</span> <span class="n">latest</span> <span class="n">count</span> <span class="n">of</span> <span class="s1">&#39;alice&#39;</span><span class="o">.</span>
<span class="o">//</span> <span class="n">Note</span><span class="p">:</span> <span class="n">The</span> <span class="n">RPC</span> <span class="n">URL</span> <span class="n">shown</span> <span class="n">below</span> <span class="ow">is</span> <span class="n">fictitious</span> <span class="ow">and</span> <span class="n">only</span> <span class="n">serves</span> <span class="n">to</span> <span class="n">illustrate</span> <span class="n">the</span> <span class="n">idea</span><span class="o">.</span>  <span class="n">Ultimately</span><span class="p">,</span>
<span class="o">//</span> <span class="n">the</span> <span class="n">URL</span> <span class="p">(</span><span class="ow">or</span><span class="p">,</span> <span class="ow">in</span> <span class="n">general</span><span class="p">,</span> <span class="n">the</span> <span class="n">method</span> <span class="n">of</span> <span class="n">communication</span><span class="p">)</span> <span class="n">will</span> <span class="n">depend</span> <span class="n">on</span> <span class="n">the</span> <span class="n">RPC</span> <span class="n">layer</span> <span class="n">you</span> <span class="n">opted</span> <span class="n">to</span>
<span class="o">//</span> <span class="n">implement</span><span class="o">.</span>  <span class="n">Again</span><span class="p">,</span> <span class="n">we</span> <span class="n">provide</span> <span class="n">end</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">end</span> <span class="n">demo</span> <span class="n">applications</span> <span class="p">(</span><span class="n">such</span> <span class="k">as</span> <span class="n">KafkaMusicExample</span><span class="p">)</span> <span class="n">that</span> <span class="n">showcase</span>
<span class="o">//</span> <span class="n">how</span> <span class="n">to</span> <span class="n">implement</span> <span class="n">such</span> <span class="n">an</span> <span class="n">RPC</span> <span class="n">layer</span><span class="o">.</span>
<span class="n">Long</span> <span class="n">result</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">getLong</span><span class="p">(</span><span class="s2">&quot;http://&quot;</span> <span class="o">+</span> <span class="n">metadata</span><span class="o">.</span><span class="n">host</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">metadata</span><span class="o">.</span><span class="n">port</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;/word-count/alice&quot;</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Get</span> <span class="n">the</span> <span class="n">word</span> <span class="n">count</span> <span class="k">for</span> <span class="n">word</span> <span class="p">(</span><span class="n">aka</span> <span class="n">key</span><span class="p">)</span> <span class="s1">&#39;alice&#39;</span><span class="p">:</span> <span class="n">Approach</span> <span class="mi">2</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">Alternatively</span><span class="p">,</span> <span class="n">we</span> <span class="n">could</span> <span class="n">also</span> <span class="n">choose</span> <span class="p">(</span><span class="n">say</span><span class="p">)</span> <span class="n">a</span> <span class="n">brute</span><span class="o">-</span><span class="n">force</span> <span class="n">approach</span> <span class="n">where</span> <span class="n">we</span> <span class="n">query</span> <span class="n">every</span> <span class="n">app</span> <span class="n">instance</span>
<span class="o">//</span> <span class="n">until</span> <span class="n">we</span> <span class="n">find</span> <span class="n">the</span> <span class="n">one</span> <span class="n">that</span> <span class="n">happens</span> <span class="n">to</span> <span class="n">know</span> <span class="n">about</span> <span class="s1">&#39;alice&#39;</span><span class="o">.</span>
<span class="n">Optional</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">streams</span><span class="o">.</span><span class="n">allMetadataForStore</span><span class="p">(</span><span class="s2">&quot;word-count&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">stream</span><span class="p">()</span>
    <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">streamsMetadata</span> <span class="o">-&gt;</span> <span class="p">{</span>
        <span class="o">//</span> <span class="n">Construct</span> <span class="n">the</span> <span class="p">(</span><span class="n">fictituous</span><span class="p">)</span> <span class="n">full</span> <span class="n">endpoint</span> <span class="n">URL</span> <span class="n">to</span> <span class="n">query</span> <span class="n">the</span> <span class="n">current</span> <span class="n">remote</span> <span class="n">application</span> <span class="n">instance</span>
        <span class="n">String</span> <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://&quot;</span> <span class="o">+</span> <span class="n">streamsMetadata</span><span class="o">.</span><span class="n">host</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">streamsMetadata</span><span class="o">.</span><span class="n">port</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;/word-count/alice&quot;</span><span class="p">;</span>
        <span class="o">//</span> <span class="n">Read</span> <span class="ow">and</span> <span class="k">return</span> <span class="n">the</span> <span class="n">count</span> <span class="k">for</span> <span class="s1">&#39;alice&#39;</span><span class="p">,</span> <span class="k">if</span> <span class="nb">any</span><span class="o">.</span>
        <span class="k">return</span> <span class="n">http</span><span class="o">.</span><span class="n">getLong</span><span class="p">(</span><span class="n">url</span><span class="p">);</span>
    <span class="p">})</span>
    <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span> <span class="o">!=</span> <span class="n">null</span><span class="p">)</span>
    <span class="o">.</span><span class="n">findFirst</span><span class="p">();</span>
</pre></div>
</div>
<p>At this point the full state of the application is interactively
queryable:</p>
<ul class="simple">
<li>You can discover the running instances of the application and the
state stores they manage locally.</li>
<li>Through the RPC layer that was added to the application, you can
communicate with these application instances over the network and
query them for locally available state.</li>
<li>The application instances are able to serve such queries because they
can directly query their own local state stores and respond via the
RPC layer.</li>
<li>Collectively, this allows us to query the full state of the entire
application.</li>
</ul>
<p>To see an end-to-end application with interactive queries, review the
<a class="reference external" href="#streams-developer-guide-interactive-queries-demos">demo
applications</a>.</p>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="app-reset-tool.html" class="btn btn-neutral float-right" title="Application Reset Tool" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="datatypes.html" class="btn btn-neutral" title="Data Types and Serialization" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Apache Software Foundation.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'4.0.0',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: ''
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>